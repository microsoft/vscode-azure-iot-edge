name: CI

on:
  push:
    branches:
      - master
    tags:
      - v*.*.*
  pull_request:
    branches:
      - master
      
jobs:
   vscode_azure_iot_edge_Stage_Linux:
    name: Linux
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Install NodeJs
      uses: actions/setup-node@v1
      with:
       node-version: 17.x
    - name: Check if release required
      id: check-tag
      run: |
          echo ::set-output name=ISPRODTAG::v?[0-9]+\.[0-9]+\.[0-9]+$
          if [[ ${{ github.ref }} =~ ^refs/tags/v?[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo ::set-output name=GITRELEASE_FLAG::true
          echo ::set-output name=SOURCE_TAG::${GITHUB_REF#refs/tags}
          elif [[ ${{ github.ref }} =~ ^refs/tags/v?[0-9]+\.[0-9]+\.[0-9]+-rc[0-9] ]]; then
          echo ::set-output name=GITRELEASE_FLAG_RC::true
          fi

    - name: npm install
      run: |
         npm install
    - name: install -g vsce
      run: |
         npm install -g vsce
    - name: npm Package
      run: |
         npm run tslint
         npm run compile
         node scripts/genAiKey.js
         echo "y" | vsce package
      env:
        GITHUB_TAG: ${{ steps.check-tag.outputs.SOURCE_TAG }}
        ISPRODTAG: ${{ steps.check-tag.outputs.ISPRODTAG }}
        PROD_AIKEY: ${{ secrets.PROD_AIKEY }}

    - name: npm test
      run: xvfb-run --auto-servernum --server-args="-screen 0, 1024x768x24" npm test --silent
    - name: docker test
      run: docker run -t --rm -v $PWD:/mnt:ro dkhamsing/awesome_bot --white-list "gitter.im/Microsoft/vscode-azure-iot-edge" --allow-dupe --allow-redirect --skip-save-results `ls *.md`
    - name: GitHub Release
      if: |
           ((success() && (steps.check-tag.outputs.GITRELEASE_FLAG == 'true')) ||
           (success() && (steps.check-tag.outputs.GITRELEASE_FLAG_RC == 'true')))

      uses: softprops/action-gh-release@v1
      with:
          files: ./**/*.vsix   
      
    - name: Publish to Marketplace
      if: |
           (success() && (steps.check-tag.outputs.GITRELEASE_FLAG == 'true'))
      run: 'vsce publish -p ${{ secrets.VSCE_TOKEN }} --packagePath *.vsix'
      
   vscode_azure_iot_edge_Stage_MacOS:
    name: Mac-OS
    runs-on: macos-latest
    steps:
        - uses: actions/checkout@v2
        - name: Install NodeJs
          uses: actions/setup-node@v1
          with:
           node-version: 17.x
        - name: npm install
          run: |
             npm install
             sudo npm install -g vsce
        - name: npm Package
          run: |
             npm run tslint
             npm run compile
             node scripts/genAiKey.js
             echo "y" | vsce package
        - name: npm test
          run: npm test --silent
